<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S4H-1 | Operator Control Center</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        danger: '#dc2626',
                        success: '#16a34a',
                        accent: '#0ea5e9',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 10px -2px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }

        .h-screen-nav {
            height: calc(100vh - 64px);
        }

        .severity-critical {
            border-left: 4px solid #dc2626;
        }

        .severity-warning {
            border-left: 4px solid #f59e0b;
        }

        .severity-safe {
            border-left: 4px solid #16a34a;
        }

        .map-bg {
            background-image: radial-gradient(#e2e8f0 1.5px, transparent 1.5px);
            background-size: 30px 30px;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .marker-ripple {
            position: absolute;
            width: 12px;
            height: 12px;
            background: rgba(220, 38, 38, 0.4);
            border-radius: 50%;
            animation: ripple 1.5s infinite;
        }
    </style>
</head>

<body class="text-slate-900">

    <!-- Top Navigation -->
    <nav class="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-6">
            <a href="{{ url_for('index') }}" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <div class="bg-primary p-1.5 rounded-lg">
                    <i data-lucide="shield-check" class="text-white w-5 h-5"></i>
                </div>
                <span class="text-lg font-display font-bold text-primary">S4H-1</span>
            </a>
            <div class="hidden md:flex items-center bg-slate-100 rounded-lg px-3 py-1.5 border border-slate-200">
                <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                <input type="text" placeholder="Search ride or district..."
                    class="bg-transparent border-none outline-none text-sm ml-2 w-64">
            </div>
        </div>

        <div class="flex items-center gap-4">
            <a href="{{ url_for('index') }}"
                class="text-xs font-bold text-slate-500 hover:text-primary transition-colors flex items-center gap-1">
                <i data-lucide="home" class="w-4 h-4"></i>
                HOME
            </a>
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('passenger_dashboard') }}"
                class="text-xs font-bold text-slate-500 hover:text-primary transition-colors flex items-center gap-1">
                <i data-lucide="user" class="w-4 h-4"></i>
                PASSENGER VIEW
            </a>
            <a href="{{ url_for('admin_console') }}"
                class="text-xs font-bold text-slate-500 hover:text-primary transition-colors flex items-center gap-1">
                <i data-lucide="shield-alert" class="w-4 h-4"></i>
                ADMIN
            </a>
            {% endif %}
            <div class="h-8 w-[1px] bg-slate-200"></div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <p class="text-xs font-bold">Operator #104</p>
                    <p class="text-[10px] text-success">Online</p>
                </div>
                <div
                    class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center">
                    <i data-lucide="user" class="text-slate-400"></i>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex h-screen-nav">
        <!-- Sidebar: Incident Feed -->
        <aside class="w-96 bg-white border-r border-slate-200 flex flex-col">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h2 class="font-bold text-sm flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-primary"></i>
                    ACTIVE ALERTS
                </h2>
                <div class="flex gap-1">
                    <button onclick="filterAlerts('all')"
                        class="px-2 py-1 text-[10px] bg-white border border-slate-200 rounded font-bold hover:bg-slate-100">All</button>
                    <button onclick="filterAlerts('critical')"
                        class="px-2 py-1 text-[10px] bg-danger/10 text-danger border border-danger/20 rounded font-bold">Critical</button>
                </div>
            </div>

            <div id="alert-feed" class="flex-1 overflow-y-auto p-3 space-y-3">
                <!-- Alerts injected here -->
            </div>
        </aside>

        <!-- Main Map Area -->
        <main class="flex-1 relative map-bg overflow-hidden flex items-center justify-center bg-slate-50">
            <!-- Mock SVG Map -->
            <svg id="main-map" viewBox="0 0 800 600" class="w-[90%] h-[90%] opacity-40">
                <path d="M100,100 L700,100 L700,500 L100,500 Z" fill="transparent" stroke="#cbd5e1" stroke-width="2" />
                <path d="M100,300 L700,300 M400,100 L400,500" stroke="#cbd5e1" stroke-dasharray="5,5" />
                <!-- Grid Labels -->
                <text x="120" y="130" class="text-[10px] fill-slate-400 font-bold">NORTH DISTRICT</text>
                <text x="520" y="480" class="text-[10px] fill-slate-400 font-bold">SOUTH QUARTER</text>
            </svg>

            <!-- Real Markers -->
            <div id="marker-container" class="absolute inset-0 pointer-events-none">
                <!-- Markers injected here -->
            </div>

            <!-- Map Controls -->
            <div class="absolute bottom-6 right-6 flex flex-col gap-2">
                <button class="bg-white p-3 rounded-xl shadow-soft border border-slate-200 hover:bg-slate-50">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
                <button class="bg-white p-3 rounded-xl shadow-soft border border-slate-200 hover:bg-slate-50">
                    <i data-lucide="minus" class="w-5 h-5"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- Details/Assign Modal -->
    <div id="assign-modal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-lg shadow-2xl overflow-hidden animate-in zoom-in duration-200">
            <div id="modal-content" class="p-8">
                <!-- Modal content injected here -->
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3"></div>

    <script>
        let incidents = [];

        // API Configuration
        const API_BASE_URL = 'http://localhost:5000/api';

        // --- Interaction Utilities ---
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let icon = 'info';
            let bgClass = 'bg-slate-900';

            if (type === 'success') { icon = 'check-circle'; bgClass = 'bg-success'; }
            if (type === 'error') { icon = 'alert-circle'; bgClass = 'bg-danger'; }

            toast.className = `${bgClass} text-white p-4 rounded-2xl shadow-2xl flex items-start gap-3 min-w-[280px] max-w-sm animate-in fade-in slide-in-from-top-4 duration-300 pointer-events-auto cursor-pointer`;
            toast.onclick = () => toast.remove();

            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5 mt-0.5"></i>
                <div>
                    <p class="font-bold text-sm">${title}</p>
                    <p class="text-xs opacity-90">${message}</p>
                </div>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-10px]');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Fetch incidents from API
        async function loadIncidents() {
            try {
                const response = await fetch(`${API_BASE_URL}/incidents`);
                const data = await response.json();

                if (data.success) {
                    incidents = data.incidents.map((inc, index) => ({
                        id: inc.id,
                        name: inc.passenger_name,
                        type: inc.type,
                        severity: inc.severity,
                        district: inc.district,
                        x: 250 + (index * 150), // Position on map
                        y: 180 + (index * 120),
                        time: inc.time_ago,
                        assigned: inc.assigned_volunteer
                    }));

                    renderFeed();
                    renderMarkers();
                }
            } catch (error) {
                console.error('Error loading incidents:', error);
                // Fallback to mock data
                incidents = [
                    { id: 'AL-9021', name: 'Kavita R.', type: 'Deviation', severity: 'critical', district: 'Sitabuldi', x: 250, y: 180, time: '2m ago', assigned: null },
                    { id: 'AL-9025', name: 'Aditya D.', type: 'Unusual Stop', severity: 'warning', district: 'Dharampeth', x: 580, y: 420, time: '5m ago', assigned: 'Vol. Pooja' },
                    { id: 'AL-9028', name: 'Rohan S.', type: 'Low Signal', severity: 'safe', district: 'Sadar', x: 320, y: 240, time: '12m ago', assigned: null }
                ];
                renderFeed();
                renderMarkers();
            }
        }

        async function init() {
            lucide.createIcons();
            await loadIncidents();

            // Real-time updates every 10 seconds
            setInterval(loadIncidents, 10000);

            // Hook up static controls
            document.querySelector('input[placeholder="Search ride or district..."]').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') showToast('Search', `Filtering for "${e.target.value}"...`);
            });

            // Map controls
            const [zoomIn, zoomOut] = document.querySelectorAll('.absolute.bottom-6 button');
            if (zoomIn) zoomIn.onclick = () => showToast('Map', 'Zooming In (Simulated)');
            if (zoomOut) zoomOut.onclick = () => showToast('Map', 'Zooming Out (Simulated)');
        }

        function renderFeed(filter = 'all') {
            const feed = document.getElementById('alert-feed');
            const filtered = filter === 'all' ? incidents : incidents.filter(i => i.severity === filter);

            feed.innerHTML = filtered.map(inc => `
                <div class="bg-white p-4 rounded-[32px] border border-slate-200 shadow-sm severity-${inc.severity} hover:shadow-md transition-all cursor-pointer group" onclick="openIncident('${inc.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${getSeverityClass(inc.severity)} uppercase">
                            ${inc.severity}
                        </span>
                        <span class="text-[10px] text-slate-400 font-medium">${inc.time}</span>
                    </div>
                    <h3 class="font-bold text-sm text-slate-900 group-hover:text-primary transition-colors">${inc.name} • ${inc.type}</h3>
                    <p class="text-[11px] text-slate-500 mt-1">District: ${inc.district}</p>
                    <div class="mt-4 flex items-center justify-between border-t border-slate-50 pt-3">
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center">
                                <i data-lucide="user" class="w-3 h-3 text-slate-400"></i>
                            </div>
                            <span class="text-[10px] font-medium text-slate-600">${inc.assigned || 'Unassigned'}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderMarkers() {
            const container = document.getElementById('marker-container');
            container.innerHTML = incidents.map(inc => `
                <div class="absolute pointer-events-auto cursor-pointer" style="left: ${inc.x}px; top: ${inc.y}px;" onclick="openIncident('${inc.id}')">
                    ${inc.severity === 'critical' ? '<div class="marker-ripple"></div>' : ''}
                    <div class="w-4 h-4 rounded-full border-2 border-white shadow-lg ${getMarkerBg(inc.severity)}"></div>
                    <div class="bg-white text-[9px] font-bold px-2 py-1 rounded shadow-soft border border-slate-200 mt-1 whitespace-nowrap -translate-x-1/2">
                        ${inc.name}
                    </div>
                </div>
            `).join('');
        }

        function getSeverityClass(sev) {
            if (sev === 'critical') return 'bg-danger/10 text-danger';
            if (sev === 'warning') return 'bg-warning/10 text-warning';
            return 'bg-success/10 text-success';
        }

        function getMarkerBg(sev) {
            if (sev === 'critical') return 'bg-danger';
            if (sev === 'warning') return 'bg-warning';
            return 'bg-primary';
        }

        function openIncident(id) {
            const inc = incidents.find(i => i.id === id);
            const modal = document.getElementById('assign-modal');
            const content = document.getElementById('modal-content');

            content.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Incident Details</span>
                        <h2 class="text-2xl font-bold">${inc.id} • ${inc.name}</h2>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
                </div>
                
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100 mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Alert Type</p>
                            <p class="text-sm font-bold text-danger">${inc.type}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">District</p>
                            <p class="text-sm font-bold">${inc.district} Sector</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-8">
                    <p class="text-xs font-bold text-slate-700">Assign Support Staff</p>
                    <select id="volunteer-select" class="w-full p-4 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-primary/20 bg-white text-sm font-medium">
                        <option value="">-- Choose Volunteer --</option>
                        <option value="Vol. Pooja">Pooja (Active in ${inc.district})</option>
                        <option value="Vol. Arjun">Arjun (Standby)</option>
                        <option value="NGO Team 04">Mahila Suraksha Team 04</option>
                    </select>
                </div>

                <div class="flex gap-3">
                    <button onclick="confirmAssignment('${inc.id}')" class="flex-1 bg-primary text-white py-4 rounded-xl font-bold text-sm shadow-lg shadow-blue-100 transition-transform active:scale-95">Assign & Dispatch</button>
                    <button onclick="showToast('Calling', 'Connecting to patrol...')" class="px-6 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors"><i data-lucide="phone" class="w-5 h-5 text-slate-500"></i></button>
                </div>
            `;

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function confirmAssignment(id) {
            const select = document.getElementById('volunteer-select');
            if (!select.value) {
                showToast("Action Required", "Please select a volunteer unit.", "error");
                return;
            }

            const inc = incidents.find(i => i.id === id);
            inc.assigned = select.value;
            inc.severity = 'safe'; // Lower risk after assignment for demo

            showToast("Unit Dispatched", `${select.value} has been assigned to ${inc.name}.`, "success");

            closeModal();
            renderFeed();
            renderMarkers();
        }

        function closeModal() {
            document.getElementById('assign-modal').style.display = 'none';
        }

        function filterAlerts(sev) {
            renderFeed(sev);
        }

        window.onload = init;
    </script>
</body>

</html>
